<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voice Call - Custom Telegram Calls</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <div class="call-container">
      <h2>üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫</h2>

      <div class="status waiting" id="status">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</div>

      <div class="user-info">
        <p><strong>–ö–æ–º–Ω–∞—Ç–∞:</strong> <span id="room-id">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
        <p>
          <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> <span id="user-id">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </p>
      </div>

      <div class="controls">
        <button id="end-call" class="end-call">‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
        <button id="mute-btn" class="mute-btn">üîá –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
      </div>

      <audio id="local-audio" muted autoplay playsinline></audio>
      <audio id="remote-audio" autoplay playsinline></audio>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/ui.js"></script>
    <script src="/js/socket-handler.js"></script>
    <script src="/js/webrtc.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const roomId = window.location.pathname.split("/")[2];
        const tg = window.Telegram?.WebApp;
        const userId =
          tg?.initDataUnsafe?.user?.id || `test-user-${Date.now()}`;

        document.getElementById("room-id").textContent = roomId;
        document.getElementById("user-id").textContent = userId;

        UI.init();
        SocketHandler.init(roomId, userId);

        if (tg) {
          tg.ready();
          tg.expand();
          if (tg.requestMicrophoneAccess) {
            const { granted } = await tg.requestMicrophoneAccess();
            if (!granted) {
              UI.showError("–î–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ Telegram");
              return;
            }
          }
        }

        await window.webRTC.autoStartCall();

        window.addEventListener("beforeunload", () => {
          if (window.webRTC?.peerConnection) {
            window.webRTC.endCall();
          }
        });
      });
    </script>
  </body>
</html>
